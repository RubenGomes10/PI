/** * Created by Ruben Gomes on 26/07/2015. */var pgSql  = require('../public/javascripts/pgSql'), // To access the database    errors = require('../public/javascripts/errors');var advertisementsDB = {    getAllAdds: function (done) {        pgSql.select('advertisement', null, function (err, results) {            if (err) return done(new errors.SqlError(err));            done(null, results);        });    },    getAddById: function (id, done) {        pgSql.select('advertisement', {id: id}, function (err, result) {            if (err) return done(new errors.SqlError(err));            done(null, result);        })    },    updateAdd: function (values, done) {        pgSql.update('advertisement', values, function (err) {            if (err) return done(new errors.SqlError(err));            done();        })    },    deleteAdd: function(id,done){        pgSql.delete('advertisement',{id: id}, function(err){            if(err) return done(new errors.SqlError(err));            done();        })    },    postAdd: function (title, description, username, country, city, photo, done) {        pgSql.insert('advertisement',            {                title: title,                description: description,                username: username,                country: country,                city: city,                pictures: photo            },            function (err) {                if (err) return done(new errors.SqlError(err));                done(null);            }        )    },    addDataToAdvertisement: function addDataToAdvertisement(adds, idx, done) {        pgSql.select('followedadvertisement', {advertisementid: adds[idx].id}, function (err, results) {            if (err) return done(new errors.SqlError(err));            adds[idx].nFollows = results.rowCount;            pgSql.select('_comment', {advertisementid: adds[idx].id}, function (err, results) {                if (err) return done(new errors.SqlError(err));                adds[idx++].nComments = results.rowCount;                if (idx < adds.length) {                    return advertisementsDB.addDataToAdvertisement(adds, idx, done);                }                done(null);            });        });    },    addCommentsToAdvertisement: function(adds, idx, done){        pgSql.query('SELECT usernameuser, description FROM _comment WHERE advertisementid=$1 ORDER BY publishdate ASC', [adds[idx].id], function(err, results){            if(err){ return done(new errors.SqlError(err));}            if(results.rowCount !== 0)               adds[idx].comments = results.rows;            if(++idx >= adds.length)                done(null);            else                module.exports.addCommentsToAdvertisement(adds, idx, done);        });    }}module.exports = advertisementsDB;